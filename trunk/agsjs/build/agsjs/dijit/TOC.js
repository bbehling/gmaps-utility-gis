/** built on 2011-11-04 */ 
dojo.provide("agsjs.dijit.TOC");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.Slider");dojo.require("dojo.fx");(function(){var a=dojo.create("link",{type:"text/css",rel:"stylesheet",href:dojo.moduleUrl("agsjs.dijit","css/TOC.css")});dojo.doc.getElementsByTagName("head")[0].appendChild(a)})();
dojo.declare("agsjs.dijit._TOCNode",[dijit._Widget,dijit._Templated],{templateString:'<div class="agsjsTOCNode"><div data-dojo-attach-point="rowNode" data-dojo-attach-event="onclick:_onClick"><span data-dojo-attach-point="contentNode" class="agsjsTOCContent"><input type="checkbox" data-dojo-attach-point="checkNode"/><img src="${_blankGif}" alt="" data-dojo-attach-point="iconNode" /><span data-dojo-attach-point="labelNode"></span></span></div><div data-dojo-attach-point="containerNode" style="display: none;"> </div></div>',layer:null,
subLayer:null,legend:null,layerTOC:null,constructor:function(a){dojo.mixin(this,a)},postCreate:function(){dojo.style(this.rowNode,"paddingLeft",""+this.layerTOC.toc.indentSize*this.layerTOC._currentIndent+"px");var a=null,b=this.iconNode.src;if(this.legend){a=this.legend;this._createLegendNode(this.legend)}else if(this.subLayer){a=this.subLayer;this._createSubLayerNode(this.subLayer);this._adjustToState()}else if(this.layer){a=this.layer;this._createLayerNode(this.layer)}if(this.containerNode)this.toggler=
new dojo.fx.Toggler({node:this.containerNode,showFunc:dojo.fx.wipeIn,hideFunc:dojo.fx.wipeOut});if(this.checkNode)this.checkNode.checked=a.visible;var d=a.visible;if(a._subLayerInfos){var c=true;dojo.every(a._subLayerInfos,function(e){if(e.visible)return c=false;return true});if(c)d=false}if(a.collapsed)d=false;if(this.iconNode&&this.iconNode.src==b){dojo.addClass(this.iconNode,"dijitTreeExpando");dojo.addClass(this.iconNode,d?"dijitTreeExpandoOpened":"dijitTreeExpandoClosed")}if(this.containerNode)dojo.style(this.containerNode,
"display",d?"block":"none");this.layerTOC.toc.style=="inline"&&this.iconNode&&this.checkNode&&dojo.place(this.iconNode,this.checkNode,"after")},_createLayerNode:function(a){dojo.addClass(this.rowNode,"agsjsTOCLayer");dojo.addClass(this.labelNode,"agsjsTOCLayerLabel");var b=this.layerTOC.info.title;a.collapsed=this.layerTOC.info.collapsed;if(this.layerTOC.info.slider){this.sliderNode=dojo.create("div",{"class":"agsjsTOCSlider"},this.rowNode,"last");this.slider=new dijit.form.HorizontalSlider({showButtons:false,
value:a.opacity*100,intermediateChanges:true,tooltip:"adjust transparency",onChange:function(d){a.setOpacity(d/100)},layoutAlign:"right"});this.slider.placeAt(this.sliderNode)}this.layerTOC.info.noLayers?dojo.style(this.iconNode,"visibility","hidden"):this._createChildrenNodes(a._tocInfos,"subLayer");this.labelNode.innerHTML=b},_createSubLayerNode:function(a){this.labelNode.innerHTML=a.name;if(a._subLayerInfos){dojo.addClass(this.rowNode,"agsjsTOCGroupLayer");dojo.addClass(this.labelNode,"agsjsTOCGroupLayerLabel");
if(this.layerTOC.info.showGroupCount)this.labelNode.innerHTML=a.name+" ("+a._subLayerInfos.length+")";this._createChildrenNodes(a._subLayerInfos,"subLayer")}else{dojo.addClass(this.rowNode,"agsjsTOCSubLayer");dojo.addClass(this.labelNode,"agsjsTOCSubLayerLabel");if(this.layer.tileInfo){dojo.destroy(this.checkNode);this.checkNode=null}if(a.renderer&&!this.layerTOC.info.noLegend)if(this.layerTOC.toc.style=="inline"&&a.renderer.symbol){this._setIconNode(a.renderer,this.iconNode,this);dojo.destroy(this.containerNode);
this.containerNode=null}else if(a.renderer instanceof esri.renderer.SimpleRenderer)this._createChildrenNodes([a.renderer],"legend");else{var b=a.renderer.infos;if(a.renderer.defaultSymbol)b=[{symbol:a.renderer.defaultSymbol,label:a.renderer.defaultLabel,isDefault:true}].concat(b);this._createChildrenNodes(b,"legend")}else if(a.legends&&!this.layerTOC.info.noLegend)if(this.layerTOC.toc.style=="inline"&&a.legends.length==1){this.iconNode.src=this._getLegendIconUrl(a.legends[0]);dojo.destroy(this.containerNode);
this.containerNode=null}else this._createChildrenNodes(a.legends,"legend");else{dojo.destroy(this.iconNode);this.iconNode=null;dojo.destroy(this.containerNode);this.containerNode=null}}this.layerTOC._layerWidgets.push(this)},_createLegendNode:function(a){a.visible=false;if(this.subLayer&&this.subLayer.definitionExpression)if(this.subLayer.renderer&&this.subLayer.renderer instanceof esri.renderer.UniqueValueRenderer)if(!a.isDefault&&this.layerTOC.toc.style=="inline")a.visible=true;a.visible||dojo.style(this.checkNode,
"visibility","hidden");dojo.destroy(this.containerNode);dojo.addClass(this.labelNode,"agsjsTOCLegendLabel");this._setIconNode(a,this.iconNode,this);this.labelNode.appendChild(document.createTextNode(a.label));a.value&&dojo.attr(this.labelNode,"datavalue",a.value)},_setIconNode:function(a,b,d){if(a.url)b.src=this._getLegendIconUrl(a);else if(a.symbol)if(a.symbol.url){b.src=this._getLegendIconUrl(a.symbol);if(a.symbol.width&&a.symbol.height){this.iconNode.width=a.symbol.width;this.iconNode.height=a.symbol.height}}else{a=
this._createSymbol(a.symbol);dojo.place(a,b,"replace");d.iconNode=a}},_createSymbol:function(a){var b=this.layerTOC.toc.swatchSize[0],d=this.layerTOC.toc.swatchSize[1];if(a.width&&a.height){b=a.width;d=a.height}var c=dojo.create("span",{style:"width:"+b+";height:"+d}),e=dojox.gfx.createSurface(c,b,d);a=esri.symbol.getShapeDescriptors(a);e.createShape(a.defaultShape).setFill(a.fill).setStroke(a.stroke).applyTransform({dx:b/2,dy:d/2});return c},_getLegendIconUrl:function(a){var b=a.url;if(b.indexOf("data")==
-1)if(!dojo.isIE&&a.imageData&&a.imageData.length>0)b="data:image/png;base64,"+a.imageData;else if(b.indexOf("http")!==0)b=this.layer.url+"/"+this.subLayer.id+"/images/"+b;return b},_createChildrenNodes:function(a,b){this.layerTOC._currentIndent++;dojo.forEach(a,function(d){var c={layerTOC:this.layerTOC,layer:this.layer,subLayer:this.subLayer,legend:this.legend};c[b]=d;c.data=d;(new agsjs.dijit._TOCNode(c)).placeAt(this.containerNode)},this);this.layerTOC._currentIndent--},_toggleContainer:function(a){if(dojo.hasClass(this.iconNode,
"dijitTreeExpandoClosed")||dojo.hasClass(this.iconNode,"dijitTreeExpandoOpened")){if(a){dojo.removeClass(this.iconNode,"dijitTreeExpandoClosed");dojo.addClass(this.iconNode,"dijitTreeExpandoOpened")}else if(a===false){dojo.removeClass(this.iconNode,"dijitTreeExpandoOpened");dojo.addClass(this.iconNode,"dijitTreeExpandoClosed")}else{dojo.toggleClass(this.iconNode,"dijitTreeExpandoClosed");dojo.toggleClass(this.iconNode,"dijitTreeExpandoOpened")}if(this.toggler)dojo.hasClass(this.iconNode,"dijitTreeExpandoOpened")?
this.toggler.show():this.toggler.hide()}},_adjustToState:function(){if(this.subLayer){var a=esri.geometry.getScale(this.layerTOC.toc.map);(a=this.subLayer.maxScale!=0&&a<this.subLayer.maxScale||this.subLayer.minScale!=0&&a>this.subLayer.minScale)?dojo.addClass(this.domNode,"agsjsTOCOutOfScale"):dojo.removeClass(this.domNode,"agsjsTOCOutOfScale");if(this.checkNode){this.checkNode.disabled=a;this.checkNode.checked=this.subLayer.visible}}},_onClick:function(a){a=a.target;if(a==this.checkNode){if(this.legend){var b=
this.subLayer.renderer;this.legend.visible=this.checkNode.checked;var d=[];if(b instanceof esri.renderer.UniqueValueRenderer){var c="";this.subLayer.fields&&dojo.forEach(this.subLayer.fields,function(e){if(e.name==b.attributeField)switch(e.type){case "esriFieldTypeString":c="'"}});dojo.forEach(b.infos,function(e){e.visible&&d.push(c+e.value+c)},this);if(d.length==b.infos.length)this.subLayer._definitionExpression="";else if(d.length==0){this.subLayer.visible=false;this.subLayer._definitionExpression=
"1=2"}else{this.subLayer.visible=true;this.subLayer._definitionExpression=b.attributeField+" IN ("+d.join(",")+")"}}this.layer.setVisibleLayers(this._getVisibleLayers(),false);this.layer.setLayerDefinitions(this._getLayerDefs(),false);this.layerTOC._refreshLayer()}else if(this.subLayer){this.subLayer.visible=this.checkNode.checked;this.layer.setLayerDefinitions(this._getLayerDefs(),false);this.layer.setVisibleLayers(this._getVisibleLayers(),false);this.layerTOC._refreshLayer();if(this.subLayer.subLayerIds)if(this.checkNode.checked){dojo.addClass(this.containerNode,
"agsjsTOCGroupOn");dojo.removeClass(this.containerNode,"agsjsTOCGroupOff")}else{dojo.addClass(this.containerNode,"agsjsTOCGroupOff");dojo.removeClass(this.containerNode,"agsjsTOCGroupOn")}}else this.layer&&this.layer.setVisibility(this.checkNode.checked);this.layerTOC.toc.style=="inline"&&this._toggleContainer(this.checkNode.checked)}else a==this.iconNode&&this._toggleContainer()},_getVisibleLayers:function(){var a=[];dojo.forEach(this.layer.layerInfos,function(b){if(!b.subLayerIds)if(b.visible)if(!b._parentLayerInfo||
b._parentLayerInfo.visible)a.push(b.id)});a.length===0&&a.push(-1);return a},_getLayerDefs:function(){var a=[];dojo.forEach(this.layer.layerInfos,function(b,d){if(b._definitionExpression)a[d]=b._definitionExpression});return a}});
dojo.declare("agsjs.dijit._LayerTOC",[dijit._Widget],{_currentIndent:0,layer:null,_layerWidgets:[],constructor:function(a){this.layer=a.layer;this.toc=a.toc;this.info=a.info||{}},postCreate:function(){this._getLayerInfos()},_getLayerInfos:function(){if(this.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer||this.layer instanceof esri.layers.ArcGISTiledMapServiceLayer){if(this.info.title===undefined){var a=this.layer.url.toLowerCase().indexOf("/rest/services/"),b=this.layer.url.toLowerCase().indexOf("/mapserver",
a);this.info.title=this.layer.url.substring(a+15,b)}}else this.info.noLayers=true;if(!this.layer.url||this.info.noLegend||this.info.noLayers)this._createLayerTOC();else if(this.info.mode=="legend")this._getLegendInfo();else if(this.info.mode=="layers")this._getLayersInfo();else{this._getLayersInfo();this._getLegendInfo()}},_getLegendInfo:function(){var a="";if(this.layer.version>=10.01)a=this.layer.url+"/legend";else{a="http://www.arcgis.com/sharing/tools/legend";var b=this.layer.url.toLowerCase().indexOf("/rest/");
b=this.layer.url.substring(0,b)+this.layer.url.substring(b+5);a=a+"?soapUrl="+escape(b)}esri.request({url:a,content:{f:"json"},callbackParamName:"callback",handleAs:"json",load:dojo.hitch(this,this._processLegendInfo),error:dojo.hitch(this,this._createLayerTOC)})},_getLayersInfo:function(){esri.request({url:this.layer.url+"/layers",content:{f:"json"},callbackParamName:"callback",handleAs:"json",load:dojo.hitch(this,this._processLayersInfo),error:dojo.hitch(this,this._createLayerTOC)})},_processLegendError:function(a){console.log(a);
this._createLayerTOC()},_processLegendInfo:function(a){this.layer._legendResponse=a;if(this.info.mode=="legend"||this.layer._layersResponse)this._createLayerTOC()},_processLayersInfo:function(a){this.layer._layersResponse=a;if(this.info.mode=="layers"||this.layer._legendResponse)this._createLayerTOC()},_createLayerTOC:function(){var a=this.layer;if(!a._tocInfos){var b={};dojo.forEach(a.layerInfos,function(c){b[""+c.id]=c;c.visible=c.defaultVisibility});a._layersResponse&&dojo.forEach(a._layersResponse.layers,
function(c){var e=b[""+c.id];if(e){dojo.mixin(e,c);e.definitionExpression=c.definitionExpression;if(c.drawingInfo&&c.drawingInfo.renderer)e.renderer=esri.renderer.fromJson(c.drawingInfo.renderer)}});a._legendResponse&&dojo.forEach(a._legendResponse.layers,function(c){var e=b[""+c.layerId];if(e&&c.legend){e.legends=c.legend;if(e.renderer)if(e.renderer.infos){var f=0;if(e.renderer.defaultSymbol){f=1;dojo.mixin(e.renderer.defaultSymbol,c.legend[0])}dojo.forEach(e.renderer.infos,function(g,h){dojo.mixin(g.symbol,
c.legend[h+f])})}else dojo.mixin(e.renderer.symbol,c.legend[0])}});dojo.forEach(a.layerInfos,function(c){if(c.subLayerIds){var e=[];dojo.forEach(c.subLayerIds,function(f,g){e[g]=b[f];e[g]._parentLayerInfo=c});c._subLayerInfos=e}});var d=[];dojo.forEach(a.layerInfos,function(c){c.parentLayerId==-1&&d.push(c)});a._tocInfos=d}this._layerNode=new agsjs.dijit._TOCNode({layerTOC:this,layer:a});this._layerNode.placeAt(this.domNode);this._visHandler=dojo.connect(a,"onVisibilityChange",this,"_adjustToState");
this._visLayerHandler=dojo.connect(a,"setVisibleLayers",this,"_adjustToState")},_refreshLayer:function(){var a=this.layer;if(this._refreshTimer){window.clearTimeout(this._refreshTimer);this._refreshTimer=null}this._refreshTimer=window.setTimeout(function(){a.setVisibleLayers(a.visibleLayers)},1E3)},_adjustToState:function(){this._layerNode.checkNode.checked=this.layer.visible;dojo.forEach(this._layerWidgets,function(a){a._adjustToState()})},destroy:function(){dojo.disconnect(this._visHandler);dojo.disconnect(this._visLayerHandler);
dojo.disconnect(this._maptypeIdHandler)}});
dojo.declare("agsjs.dijit.TOC",[dijit._Widget],{indentSize:18,swatchSize:[30,30],style:"inline",layerInfos:null,slider:false,constructor:function(a){a=a||{};if(!a.map)throw new Error("no map defined in params for TOC");dojo.mixin(this,a);this._layerWidgets=[];if(!this.layerInfos){this.layerInfos=[];for(a=this.map.layerIds.length-1;a>=0;a--){var b=this.map.getLayer(this.map.layerIds[a]);!b._isBaseMap&&!b._isReference&&this.layerInfos.push({layer:b})}}},postCreate:function(){var a=[];dojo.forEach(this.layerInfos,
function(b){if(!b.layer){b.layer=this._createLayer(b);a.push(b.layer)}},this);if(a.length==0)this._createTOC();else{dojo.connect(this.map,"onLayersAddResult",this,function(){this._createTOC()});this.map.addLayers(a)}},_createLayer:function(a){var b=null;switch(a.type||"ArcGISDynamic"){case "ArcGISDynamic":b=new esri.layers.ArcGISDynamicMapServiceLayer(a.url,a);break}return b},_createTOC:function(){for(var a=0,b=this.layerInfos.length;a<b;a++){var d=new agsjs.dijit._LayerTOC({layer:this.layerInfos[a].layer,
info:this.layerInfos[a],toc:this});this._layerWidgets.push(d);d.placeAt(this.domNode)}this._zoomHandler=dojo.connect(this.map,"onZoomEnd",this,"_adjustToState")},_adjustToState:function(){dojo.forEach(this._layerWidgets,function(a){a._adjustToState()})},destroy:function(){dojo.disconnect(this._zoomHandler)}});
