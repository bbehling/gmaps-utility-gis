/*built on 2012-07-19 12:54:07.57*/ 
define("agsjs/layers/GoogleMapsLayer",["dojo","dijit","dojox","dojo/require!esri/dijit/BasemapGallery"],function(b){b.provide("agsjs.layers.GoogleMapsLayer");b.declare("agsjs.layers.GoogleMapsLayer",esri.layers.Layer,{constructor:function(a){a=a||{};this.tileInfo=new esri.layers.TileInfo({rows:256,cols:256,dpi:96,origin:{x:-2.0037508342787E7,y:2.0037508342787E7},spatialReference:{wkid:102100},lods:[{level:0,resolution:156543.033928,scale:5.91657527591555E8},{level:1,resolution:78271.5169639999,scale:2.95828763795777E8},
{level:2,resolution:39135.7584820001,scale:1.47914381897889E8},{level:3,resolution:19567.8792409999,scale:7.3957190948944E7},{level:4,resolution:9783.93962049996,scale:3.6978595474472E7},{level:5,resolution:4891.96981024998,scale:1.8489297737236E7},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.99245256249,scale:4622324.434309},{level:8,resolution:611.49622628138,scale:2311162.217155},{level:9,resolution:305.748113140558,scale:1155581.108577},{level:10,resolution:152.874056570411,
scale:577790.554289},{level:11,resolution:76.4370282850732,scale:288895.277144},{level:12,resolution:38.2185141425366,scale:144447.638572},{level:13,resolution:19.1092570712683,scale:72223.819286},{level:14,resolution:9.55462853563415,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.38865713397468,scale:9027.977411},{level:17,resolution:1.19432856685505,scale:4513.988705},{level:18,resolution:0.597164283559817,scale:2256.994353},{level:19,resolution:0.298582141647617,
scale:1128.497176},{level:20,resolution:0.149291070823808,scale:564.248588}]});this.fullExtent=new esri.geometry.Extent({xmin:-2.003750834E7,ymin:-2.003750834E7,xmax:2.003750834E7,ymax:2.003750834E7,spatialReference:{wkid:102100}});this.initialExtent=new esri.geometry.Extent({xmin:-2.003750834E7,ymin:-2.003750834E7,xmax:2.003750834E7,ymax:2.003750834E7,spatialReference:{wkid:102100}});this.opacity=a.opacity||1;this._mapOptions=a.mapOptions||{};this._apiOptions=b.mixin({sensor:false},a.apiOptions||
{});this._gmap=null;this.loaded=true;this.onLoad(this)},getGoogleMapInstance:function(){return this._gmap},_setMap:function(a,c){this._map=a;var d={position:"absolute",top:"0px",left:"0px",width:"0px",height:"0px"},e=b.create("div",{},c);if(this.id)e.id=this.id;b.style(e,d);this._element=e;var f=b.create("div",{},e);b.style(f,d);b.style(f,"width",(a.width||c.offsetWidth)+"px");b.style(f,"height",(a.height||c.offsetHeight)+"px");this._gmapDiv=f;var g=b.create("div",{},a.id);g.id="gmaps_top_"+f.id;
b.style(g,d);this._topDiv=g;g=b.create("div",{},a.id);g.id="gmaps_controls_"+f.id;b.style(g,b.mixin(d,{top:"5px",left:"5px"}));this._controlDiv=g;this._connects=[];this._connects.push(b.connect(this,"onVisibilityChange",this,this._visibilityChangeHandler));this._connects.push(b.connect(this,"onOpacityChange",this,this._opacityChangeHandler));(this.visible=this.visible===undefined?true:this.visible)&&this._initGMap();return e},_unsetMap:function(){b.forEach(this._connects,b.disconnect,b);this._streetView&&
this._streetView.setVisible(false);if(google&&google.maps&&google.maps.event){this._gmapTypeChangeHandle&&google.maps.event.removeListener(this._gmapTypeChangeHandle);this._svVisibleHandle&&google.maps.event.removeListener(this._svVisibleHandle)}this._element&&this._element.parentNode.removeChild(this._element);b.destroy(this._element);this._controlDiv&&this._controlDiv.parentNode.removeChild(this._controlDiv);b.destroy(this._controlDiv);this._topDiv&&this._topDiv.parentNode.removeChild(this._topDiv);
b.destroy(this._topDiv)},_initGMap:function(){window.google=window.google||{};if(window.google&&google.maps){var a=this._map.extent,c=this._mapOptions.center||this._esriPointToLatLng(a.getCenter()),d=this._map.getLevel();c=b.mixin({center:c,zoom:d>-1?d:1,panControl:false,mapTypeControl:false,zoomControl:false},this._mapOptions);c.mapTypeId=c.mapTypeId?this._getGMapTypeId(c.mapTypeId):google.maps.MapTypeId.ROADMAP;c=new google.maps.Map(this._gmapDiv,c);d<0&&b.connect(this._map,"onLoad",b.hitch(this,
function(){this._setExtent(a)}));this._gmap=c;this._setExtent(a);this._extentChangeHandle=b.connect(this._map,"onExtentChange",this,this._extentChangeHandler);this._panHandle=b.connect(this._map,"onPan",this,this._panHandler);this._resizeHandle=b.connect(this._map,"onResize",this,this._resizeHandler);this._mvHandle=b.connect(this._map,"onMouseMove",b.hitch(this,this._moveControls));this._gmapTypeChangeHandle=google.maps.event.addListener(this._gmap,"maptypeid_changed",b.hitch(this,this._mapTypeChangeHandler));
this._gmapTiltChangeHandle=google.maps.event.addListener(this._gmap,"tilt_changed",b.hitch(this,this._mapTiltChangeHandler))}else if(agsjs.onGMapsApiLoad)b.connect(agsjs,"onGMapsApiLoad",this,this._initGMap);else{agsjs.onGMapsApiLoad=function(){};b.connect(agsjs,"onGMapsApiLoad",this,this._initGMap);d=document.createElement("script");d.type="text/javascript";var e=window.location.protocol;if(e.toLowerCase().indexOf("http")==-1)e="http:";e=e+"//maps.googleapis.com/maps/api/js?callback=agsjs.onGMapsApiLoad";
for(c in this._apiOptions)if(this._apiOptions.hasOwnProperty(c))e+="&"+c+"="+this._apiOptions[c];d.src=e;document.getElementsByTagName("head").length>0?document.getElementsByTagName("head")[0].appendChild(d):document.body.appendChild(d)}},setOpacity:function(a){if(this._gmapDiv){a=Math.min(Math.max(a,0),1);var c=this._gmapDiv.style;if(typeof c.opacity!=="undefined")c.opacity=a;else if(typeof c.filters!=="undefined")c.filters.alpha.opacity=Math.floor(100*a);else if(typeof c.filter!=="undefined")c.filter=
"alpha(opacity:"+Math.floor(a*100)+")"}this.opacity=a},setMapTypeId:function(a){if(this._gmap){this._gmap.setMapTypeId(this._getGMapTypeId(a));this._mapTypeChangeHandler()}else this._mapOptions.mapTypeId=a},setMapStyles:function(a){if(this._styleOptions)a=a||[];if(a)if(this._gmap){this._styleOptions=a;this._gmap.setOptions({styles:a})}else this._mapOptions.styles=a},onMapTypeChange:function(){},_getGMapTypeId:function(a){if(google&&google.maps)switch(a){case agsjs.layers.GoogleMapsLayer.MAP_TYPE_ROADMAP:return google.maps.MapTypeId.ROADMAP;
case agsjs.layers.GoogleMapsLayer.MAP_TYPE_HYBRID:return google.maps.MapTypeId.HYBRID;case agsjs.layers.GoogleMapsLayer.MAP_TYPE_SATELLITE:return google.maps.MapTypeId.SATELLITE;case agsjs.layers.GoogleMapsLayer.MAP_TYPE_TERRAIN:return google.maps.MapTypeId.TERRAIN}return a},_opacityChangeHandler:function(a){this.setOpacity(a)},_visibilityChangeHandler:function(a){if(a){esri.show(this._gmapDiv);esri.show(this._controlDiv);this.visible=true;if(this._gmap){google.maps.event.trigger(this._gmap,"resize");
this._panHandle=this._panHandle||b.connect(this._map,"onPan",this,this._panHandler);this._extentChangeHandle=this._extentChangeHandle||b.connect(this._map,"onExtentChange",this,this._extentChangeHandler);this._setExtent(this._map.extent)}else this._initGMap()}else if(this._gmapDiv){esri.hide(this._gmapDiv);esri.hide(this._controlDiv);this.visible=false;this._gmap&&this._map.setExtent(this._latLngBoundsToEsriExtent(this._gmap.getBounds()));this._streetView&&this._streetView.setVisible(false);if(this._panHandle){b.disconnect(this._panHandle);
this._panHandle=null}if(this._extentChangeHandle){b.disconnect(this._extentChangeHandle);this._extentChangeHandle=null}}},_resizeHandler:function(){b.style(this._gmapDiv,{width:this._map.width+"px",height:this._map.height+"px"});google.maps.event.trigger(this._gmap,"resize")},_extentChangeHandler:function(a,c,d){d?this._setExtent(a):this._gmap.setCenter(this._esriPointToLatLng(a.getCenter()))},_panHandler:function(a){this._gmap.getTilt()==0&&this._gmap.setCenter(this._esriPointToLatLng(a.getCenter()))},
_mapTypeChangeHandler:function(){this._checkZoomLevel();this.onMapTypeChange(this._gmap.getMapTypeId())},_checkZoomLevel:function(){var a=this._gmap.getMapTypeId(),c=this._gmap.mapTypes,d=null;for(var e in c)if(c.hasOwnProperty(e)&&e==a){d=c[e];break}if(d!=null){a=d.minZoom;d=d.maxZoom;c=this._map.getLevel();d!==undefined&&c>d&&this._map.setLevel(d);a!=undefined&&c<a&&this._map.setLevel(a)}},_setExtent:function(a){var c=this._esriPointToLatLng(a.getCenter());this._map.getLevel();this._gmap.fitBounds(this._esriExtentToLatLngBounds(a.expand(0.5)));
this._gmap.setCenter(c);this._checkZoomLevel()},_moveControls:function(){if(this._mvHandle)if(this._gmap){if(!this._svMoved)if(this._streetView=this._gmap.getStreetView()){var a=b.query('.gmnoprint img[src*="cb_scout_sprite"]',this._gmapDiv);if(a.length>0){b.forEach(a,function(c){b.place(c.parentNode.parentNode,this._controlDiv)},this);this._svMoved=true;this._svVisibleHandle=google.maps.event.addListener(this._streetView,"visible_changed",b.hitch(this,this._streetViewVisibilityChangeHandler))}}else this._svMoved=
true;if(!this._rotateMoved){a=b.query('.gmnoprint img[src*="rotate"]',this._gmapDiv);if(a.length>0){b.forEach(a,function(c){b.place(c.parentNode.parentNode,this._controlDiv);b.style(c,"position","absolute");b.style(c,"left","20px")},this);this._rotateMoved=true}}if(this._rotateMoved&&this._svMoved){b.disconnect(this._mvHandle);this._mvHandle=null}}else{b.disconnect(this._mvHandle);this._mvHandle=null}},_streetViewVisibilityChangeHandler:function(){if(this._streetView){var a=this._streetView.getVisible();
this._toggleEsriControl(a);this.onStreetViewVisibilityChange(a)}},_mapTiltChangeHandler:function(){var a=this._gmap.getTilt();if(a==45){b.place(this._gmapDiv,this._topDiv);this._map.disableMapNavigation()}else if(a==0){b.place(this._gmapDiv,this._element);this._map.enableMapNavigation()}},_toggleEsriControl:function(a){if(a){this._isZoomSliderDefault=this._map.isZoomSlider;this._map.hideZoomSlider();this._map.disableMapNavigation()}else{this._isZoomSliderDefault&&this._map.showZoomSlider();this._map.enableMapNavigation()}},
onStreetViewVisibilityChange:function(){},_esriPointToLatLng:function(a){a=esri.geometry.webMercatorToGeographic(a);return new google.maps.LatLng(a.y,a.x)},_esriExtentToLatLngBounds:function(a){a=esri.geometry.webMercatorToGeographic(a);return new google.maps.LatLngBounds(new google.maps.LatLng(a.ymin,a.xmin,true),new google.maps.LatLng(a.ymax,a.xmax,true))},_latLngBoundsToEsriExtent:function(a){a=new esri.geometry.Extent(a.getSouthWest().lng(),a.getSouthWest().lat(),a.getNorthEast().lng(),a.getNorthEast().lat());
return esri.geometry.geographicToWebMercator(a)}});b.mixin(agsjs.layers.GoogleMapsLayer,{MAP_TYPE_SATELLITE:"satellite",MAP_TYPE_HYBRID:"hybrid",MAP_TYPE_ROADMAP:"roadmap",MAP_TYPE_TERRAIN:"terrain",MAP_STYLE_GRAY:[{featureType:"all",stylers:[{saturation:-80},{lightness:20}]}],MAP_STYLE_LIGHT_GRAY:[{featureType:"all",stylers:[{saturation:-80},{lightness:60}]}],MAP_STYLE_NIGHT:[{featureType:"all",stylers:[{invert_lightness:"true"}]}]});require(["esri/dijit/BasemapGallery"],function(){esri.dijit.BasemapGallery.prototype._original_postMixInProperties=
esri.dijit.BasemapGallery.prototype.postMixInProperties;esri.dijit.BasemapGallery.prototype._original_startup=esri.dijit.BasemapGallery.prototype.startup;b.extend(esri.dijit.BasemapGallery,{google:null,_googleLayers:[],toggleReference:false,postMixInProperties:function(){if(!this._OnSelectionChangeListenerExt)this._onSelectionChangeListenerExt=b.connect(this,"onSelectionChange",this,this._onSelectionChangeExt);if(this.google!=undefined&&(this.showArcGISBasemaps||this.basemapsGroup)){this.basemaps.push(new esri.dijit.Basemap({id:"google_road",
layers:[new esri.dijit.BasemapLayer({type:"GoogleMapsRoad"})],title:"Google Road",thumbnailUrl:b.moduleUrl("agsjs.dijit","images/googleroad.png")}));this.basemaps.push(new esri.dijit.Basemap({id:"google_satellite",layers:[new esri.dijit.BasemapLayer({type:"GoogleMapsSatellite"})],title:"Google Satellite",thumbnailUrl:b.moduleUrl("agsjs.dijit","images/googlesatellite.png")}));this.basemaps.push(new esri.dijit.Basemap({id:"google_hybrid",layers:[new esri.dijit.BasemapLayer({type:"GoogleMapsHybrid"})],
title:"Google Hybrid",thumbnailUrl:b.moduleUrl("agsjs.dijit","images/googlehybrid.png")}))}if(this.loaded)this._onLoadExt();else this._onLoadListenerExt=b.connect(this,"onLoad",this,this._onLoadExt);this._original_postMixInProperties&&this._original_postMixInProperties()},startup:function(){this._startupCalled=true;this._original_startup();if(!this._onGalleryClickListenerExt)this._onGalleryClickListenerExt=b.connect(this.domNode,"click",this,this._onGalleryClickExt)},_onLoadExt:function(){this._onLoadListenerExt&&
b.disconnect(this._onLoadListenerExt);this.toggleReference&&b.forEach(this.basemaps,function(a){var c=a.getLayers();c.length?this._processReferenceLayersExt(a):c.then(b.hitch(this,this._processReferenceLayersExt,a))},this)},_processReferenceLayersExt:function(a){var c=a.getLayers(),d=false,e=true;b.forEach(c,function(g){if(g.isReference){d=true;if(g.visibility===false)e=false}});if(d&&this.toggleReference){a.title+='<input type="checkbox"  disabled '+(e?"checked":"")+"/>";a._hasReference=true}else a._hasReference=
false;var f=0;b.forEach(this.basemaps,function(g){if(g._hasReference==undefined)f-=this.basemaps.length;g._hasReference&&f++},this);f>=0&&f>0&&this._startupCalled&&this.startup()},_onSelectionChangeExt:function(){var a=this.getSelected(),c;if(a){if(this._googleLayers.length>0){b.forEach(this._googleLayers,function(d){this.map.removeLayer(d)},this);this._googleLayers.length=0}b.query("input",this.domNode).forEach(function(d){d.disabled=true});a=a.getLayers();b.forEach(a,function(d){if(d.type&&d.type.indexOf("GoogleMaps")>
-1){var e=agsjs.layers.GoogleMapsLayer.MAP_TYPE_ROADMAP;if(d.type=="GoogleMapsSatellite")e=agsjs.layers.GoogleMapsLayer.MAP_TYPE_SATELLITE;else if(d.type=="GoogleMapsHybrid")e=agsjs.layers.GoogleMapsLayer.MAP_TYPE_HYBRID;this.google=this.google||{};this.google.mapOptions=this.google.mapOptions||{};this.google.mapOptions.mapTypeId=e;c=new agsjs.layers.GoogleMapsLayer(this.google);this.map.addLayer(c,0);this._googleLayers.push(c)}},this)}if(!this._checkSelectedNode()&&this._startupCalled){this.startup();
this._checkSelectedNode()}},_checkSelectedNode:function(){var a=false,c=this.getSelected().getLayers();b.query(".esriBasemapGallerySelectedNode",this.domNode).forEach(function(d){a=true;b.query("input",d).forEach(function(e){e.disabled=false;b.forEach(c,function(f){if(f.isReference)f.visibility=e.checked},this)},this)},this);return a},_onGalleryClickExt:function(a){a=a.target;if(a.tagName.toLowerCase()=="input")this._setReferenceVis(a.checked);else b.hasClass(a.parentNode,"esriBasemapGalleryLabelContainer")&&
a.parentNode.parentNode.firstChild.click()},_setReferenceVis:function(a){b.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);if(c._basemapGalleryLayerType=="reference")a?c.show():c.hide()},this)},getGoogleLayers:function(){return this._googleLayers}})})});
